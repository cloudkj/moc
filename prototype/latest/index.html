<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile Game Controller - Floor Toggle</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #2a2b2e; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }

        /* Joystick */
        #zone_joystick {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 120px;
            z-index: 10;
        }

        /* Status UI */
        #status-text {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #ffffff;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 20px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            pointer-events: none;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        /* Top Right UI Container */
        #ui-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        /* Dropdown Styling */
        select {
            appearance: none;
            -webkit-appearance: none;
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px 35px 10px 15px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
            outline: none;
            cursor: pointer;
        }

        /* Checkbox Styling */
        .toggle-container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #333;
            font-weight: bold;
            cursor: pointer;
        }
        
        input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        #loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: sans-serif;
            font-size: 1.5rem;
            color: white;
            pointer-events: none;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading-text">Loading Model...</div>
    <div id="status-text">State: Idle</div>
    
    <div id="ui-container">
        <select id="model-select"></select>
        
        <label class="toggle-container">
            <input type="checkbox" id="floor-toggle" checked>
            Show Floor
        </label>
    </div>

    <div id="zone_joystick"></div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- CONFIGURATION ---
        
        // ADD YOUR GLB FILES HERE
        const MODEL_LIST = [
            { name: 'Creature', url: '../models/starbot0_meshy_v4.glb' }, 
            { name: 'Robot',    url: '../models/starbot0_tripo3d_3p0.glb' },
            { name: 'Hero',     url: '../models/starbot1_meshy_v4_animated.glb' },
            { name: 'Hero',     url: '../models/starbot2_tripo3d_meshy_v4_animated.glb' } 
        ];

        const ANIM_NAMES = {
            idle: 'Idle',  
            walk: 'Walking',  
            run:  'Running'    
        };
        
        const RUN_THRESHOLD = 0.8; 
        const BACKGROUND_COLOR = 0x2a2b2e;
        const SPEED_WALK = 0.5; 
        const SPEED_RUN = 1.5;

        // --- VARIABLES ---
        let mixer, model;
        let actions = {};
        let activeAction;
        let currentState = 'idle'; 
        const clock = new THREE.Clock();
        const loader = new GLTFLoader();

        // --- UI POPULATION ---
        const selectEl = document.getElementById('model-select');
        MODEL_LIST.forEach((m) => {
            const option = document.createElement('option');
            option.value = m.url;
            option.text = m.name;
            selectEl.appendChild(option);
        });

        // Event: Switch Model
        selectEl.addEventListener('change', (e) => {
            loadModel(e.target.value);
        });

        // Event: Toggle Floor
        const floorToggle = document.getElementById('floor-toggle');
        floorToggle.addEventListener('change', (e) => {
            const isVisible = e.target.checked;
            if (floor) floor.visible = isVisible;
            if (gridHelper) gridHelper.visible = isVisible;
        });

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(BACKGROUND_COLOR);
        scene.fog = new THREE.Fog(BACKGROUND_COLOR, 10, 50);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 3, 6);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        document.body.appendChild(renderer.domElement);

        // --- LIGHTING ---
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
        hemiLight.position.set(0, 20, 0);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- FLOOR & GRID ---
        function getCheckerboardTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const context = canvas.getContext('2d');
            context.fillStyle = '#404040'; 
            context.fillRect(0, 0, 512, 512);
            context.fillStyle = '#505050'; 
            context.fillRect(0, 0, 256, 256);
            context.fillRect(256, 256, 256, 256);
            
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(20, 20); 
            tex.anisotropy = 16;
            tex.center.set(0.5, 0.5);
            return tex;
        }

        const floorTexture = getCheckerboardTexture();
        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({ 
            map: floorTexture, 
            roughness: 0.8,
            metalness: 0.1
        });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        const gridHelper = new THREE.GridHelper(100, 50, 0x888888, 0x000000);
        gridHelper.position.y = 0.01; 
        gridHelper.material.opacity = 0.2;
        gridHelper.material.transparent = true;
        scene.add(gridHelper);

        // --- CONTROLS ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enablePan = false;
        controls.enableDamping = true;
        controls.minDistance = 2;
        controls.maxDistance = 15;
        controls.maxPolarAngle = Math.PI / 2 - 0.05;

        // --- JOYSTICK ---
        const joystickManager = nipplejs.create({
            zone: document.getElementById('zone_joystick'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'white'
        });

        joystickManager.on('move', function (evt, data) {
            if (!model) return;
            const angle = data.angle.radian;
            const targetRotation = angle - Math.PI / 2; 
            
            let diff = targetRotation - model.rotation.y;
            while (diff > Math.PI) diff -= Math.PI * 2;
            while (diff < -Math.PI) diff += Math.PI * 2;
            model.rotation.y += diff * 0.1; 

            const force = Math.min(data.force, 1.5);
            if (force > RUN_THRESHOLD) switchAction('run');
            else switchAction('walk');
        });

        joystickManager.on('end', () => switchAction('idle'));

        // --- MODEL LOADING ---
        function loadModel(url) {
            document.getElementById('loading-text').style.display = 'block';
            document.getElementById('loading-text').innerText = 'Loading Model...';

            // 1. Cleanup
            if (model) {
                scene.remove(model);
                model.traverse((o) => {
                    if (o.geometry) o.geometry.dispose();
                    if (o.material) {
                        if (Array.isArray(o.material)) o.material.forEach(m => m.dispose());
                        else o.material.dispose();
                    }
                });
                model = null;
                mixer = null;
                actions = {};
                activeAction = null;
            }

            // 2. Load
            loader.load(url, function (gltf) { 
                model = gltf.scene;
                scene.add(model);
                
                model.traverse(o => { if (o.isMesh) o.castShadow = true; });

                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                model.position.x += (model.position.x - center.x);
                model.position.y += (model.position.y - center.y); 
                model.position.z += (model.position.z - center.z);

                mixer = new THREE.AnimationMixer(model);
                
                if (gltf.animations && gltf.animations.length > 0) {
                    gltf.animations.forEach(clip => { actions[clip.name] = mixer.clipAction(clip); });

                    const idleClip = actions[ANIM_NAMES.idle] || actions[gltf.animations[0]?.name];
                    const walkClip = actions[ANIM_NAMES.walk] || actions[gltf.animations[1]?.name];
                    const runClip  = actions[ANIM_NAMES.run]  || actions[gltf.animations[2]?.name];

                    if (idleClip) actions['idle'] = idleClip;
                    if (walkClip) actions['walk'] = walkClip;
                    if (runClip)  actions['run']  = runClip;

                    currentState = 'idle';
                    activeAction = actions['idle'];
                    if(activeAction) activeAction.play();
                }

                document.getElementById('loading-text').style.display = 'none';

            }, undefined, function(e) {
                console.error(e);
                document.getElementById('loading-text').innerText = 'Error loading ' + url;
            });
        }

        loadModel(MODEL_LIST[0].url);

        // --- ANIMATION SWITCHER ---
        function switchAction(newState) {
            if (currentState === newState) return;
            const newAction = actions[newState];
            const oldAction = activeAction;
            
            if (!newAction) return;

            document.getElementById('status-text').innerText = newState;
            
            newAction.reset();
            newAction.play();
            if (oldAction) newAction.crossFadeFrom(oldAction, 0.2, true);

            activeAction = newAction;
            currentState = newState;
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (mixer) mixer.update(delta);
            controls.update();
            renderer.render(scene, camera);

            // Floor logic (only update if floor is visible)
            if (model && floor.visible) {
                floorTexture.rotation = model.rotation.y;
                gridHelper.rotation.y = model.rotation.y;

                let currentScrollSpeed = 0;
                if (currentState === 'walk') currentScrollSpeed = SPEED_WALK;
                else if (currentState === 'run') currentScrollSpeed = SPEED_RUN;
                
                floorTexture.offset.y -= currentScrollSpeed * delta;
            }
        }

        animate();
    </script>
</body>
</html>